version: "3.8"

# ==========================================================================
# Platform Server Deployment
# ==========================================================================
# Usage:
#   DATABASE_URL="postgresql://user:pass@host:5432/db" docker compose -f docker-compose.server.yml up -d
#
# Example with Supabase:
#   DATABASE_URL="postgresql://postgres:PASSWORD@db.xxx.supabase.co:5432/postgres" docker compose -f docker-compose.server.yml up -d
# ==========================================================================

services:
  platform-server:
    image: ghcr.io/platformnetwork/platform:latest
    container_name: platform-server
    restart: unless-stopped
    entrypoint: ["platform", "server"]
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    command:
      - --port
      - "8080"
    ports:
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - RUST_LOG=info,platform_server=debug
    dns:
      - 8.8.8.8
      - 1.1.1.1
    networks:
      - platform-challenges
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================================================
  # Watchtower - Auto-update platform-server container
  # ==========================================================================
  watchtower:
    image: nickfedor/watchtower@sha256:053e7ecba848b77eb5b966d236c2f4f2e1155e05007c9ef52418b4b7e255484b
    container_name: platform-server-watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_LABEL_ENABLE=true
      - WATCHTOWER_SCHEDULE=0 */5 * * * *
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_INCLUDE_STOPPED=false
      - WATCHTOWER_LOG_LEVEL=info
    networks:
      - platform-challenges

networks:
  platform-challenges:
    driver: bridge
    name: platform-challenges
