# =============================================================================
# Platform Validator Configuration
# =============================================================================
# Fully decentralized P2P architecture
#
# Usage:
#   export VALIDATOR_SECRET_KEY="your-mnemonic-or-hex-key"
#   docker compose up -d
# =============================================================================

services:
  # ==========================================================================
  # Platform Validator Node
  # ==========================================================================
  validator:
    image: ghcr.io/platformnetwork/platform:latest
    container_name: platform-validator
    restart: unless-stopped
    # SECURITY NOTE: Privileged mode is required for Docker-in-Docker to spawn challenge containers.
    # This is necessary for the decentralized evaluation architecture where validators run
    # challenge containers locally. If you don't need to run challenges, remove this line.
    privileged: true
    
    # Enable Watchtower auto-update for this container only
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    
    ports:
      - "9000:9000"   # P2P libp2p port
      - "8080:8080"   # Local RPC API (optional)
      - "8090:8090"   # Container Broker WebSocket
    
    volumes:
      - validator-data:/data
      - /var/run/docker.sock:/var/run/docker.sock
    
    environment:
      - RUST_LOG=info,validator_node=debug,platform_p2p_consensus=debug
      - DATA_DIR=/data
      - VALIDATOR_SECRET_KEY=${VALIDATOR_SECRET_KEY}
      # Subtensor endpoint (Bittensor mainnet)
      - SUBTENSOR_ENDPOINT=wss://entrypoint-finney.opentensor.ai:443
      # Network UID for this subnet
      - NETUID=100
      # P2P settings
      - P2P_LISTEN_ADDR=/ip4/0.0.0.0/tcp/9000
      # Optional: Bootstrap peers (comma-separated multiaddrs)
      # - BOOTSTRAP_PEERS=/ip4/x.x.x.x/tcp/9000/p2p/PEER_ID
    
    command: ["validator-node", "--data-dir", "/data", "--listen-addr", "/ip4/0.0.0.0/tcp/9000"]
    
    healthcheck:
      test: ["CMD-SHELL", "test -f /data/distributed.db || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    networks:
      - platform

  # ==========================================================================
  # Watchtower - Auto-update platform container only
  # ==========================================================================
  watchtower:
    image: nickfedor/watchtower@sha256:053e7ecba848b77eb5b966d236c2f4f2e1155e05007c9ef52418b4b7e255484b
    container_name: platform-watchtower
    restart: unless-stopped
    
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    
    environment:
      # Only update containers with label "com.centurylinklabs.watchtower.enable=true"
      - WATCHTOWER_LABEL_ENABLE=true
      # Check at :00, :05, :10, :15... (all validators sync at same time)
      - WATCHTOWER_SCHEDULE=0 */5 * * * *
      # Remove old images after update
      - WATCHTOWER_CLEANUP=true
      # Include stopped containers
      - WATCHTOWER_INCLUDE_STOPPED=false
      # Logging
      - WATCHTOWER_LOG_LEVEL=info
    
    networks:
      - platform

volumes:
  validator-data:
    driver: local

networks:
  platform:
    driver: bridge
